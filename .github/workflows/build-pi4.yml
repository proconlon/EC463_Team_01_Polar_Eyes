name: Build Pi 4 Image

on:
  push:
    paths:
      - 'storage_pi_four/**' # Only run when Pi 4 code/config changes
  pull_request:
    paths:
      - 'storage_pi_four/**'

jobs:
  build-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    # - name: 2. Install Packer
    #   uses: hashicorp/setup-packer@v3

    - name: 3. Install QEMU (for ARM emulation)
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static kpartx rsync

    - name: Cache base OS image
      id: cache-raspios
      uses: actions/cache@v4
      with:
        # This is the path to the decompressed image
        path: base-raspios-lite-arm64.img
        # This key is based on the image date. If you change the URL below, change this key.
        key: ${{ runner.os }}-raspios-trixie-2025-10-01

    - name: 4. Download base Raspberry Pi OS image
      if: steps.cache-raspios.outputs.cache-hit != 'true'
      run: |
        # This whole step will be skipped if the cache was found
        echo "Downloading Base OS..."
        wget -nv https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2025-10-02/2025-10-01-raspios-trixie-arm64-lite.img.xz
        echo "Decompressing..."
        unxz 2025-10-01-raspios-trixie-arm64-lite.img.xz
        # Rename it to what Packer expects
        mv 2025-10-01-raspios-trixie-arm64-lite.img base-raspios-lite-arm64.img
      
    - name: 5. Customize Image using Chroot
      run: |
        IMAGE_FILE=${{ github.workspace }}/base-raspios-lite-arm64.img
        
        echo "Workspace is at: ${{ github.workspace }}"
        echo "Listing files:"
        ls -lh ${{ github.workspace }}
        
        if [ ! -f "$IMAGE_FILE" ]; then
          echo "::error::Image file does not exist at $IMAGE_FILE"
          exit 1
        fi

        echo "Setting up loop device..."
        LOOP_DEV=$(sudo losetup -f --show $IMAGE_FILE)
        echo "Image attached to $LOOP_DEV"
        sudo kpartx -av $LOOP_DEV

        echo "Mounting filesystems..."
        MOUNT_DIR="/mnt/raspi-root"
        sudo mkdir -p $MOUNT_DIR
        
        sleep 2
        LOOP_NAME=$(basename $LOOP_DEV)
        sudo mount /dev/mapper/${LOOP_NAME}p2 $MOUNT_DIR
        sudo mkdir -p $MOUNT_DIR/boot/firmware
        sudo mount /dev/mapper/${LOOP_NAME}p1 $MOUNT_DIR/boot/firmware
        
        echo "Setting up chroot environment..."
        sudo mount --bind /dev $MOUNT_DIR/dev
        sudo mount --bind /dev/pts $MOUNT_DIR/dev/pts
        sudo mount --bind /proc $MOUNT_DIR/proc
        sudo mount --bind /sys $MOUNT_DIR/sys
        
        echo "Copying project files..."
        sudo cp /usr/bin/qemu-arm-static $MOUNT_DIR/usr/bin/
        sudo rsync -av --exclude='base-raspios-lite-arm64.img' --exclude='build/' ${{ github.workspace }}/ $MOUNT_DIR/opt/polar-eyes/
        
        echo "Setting executable permission on setup script..."
        SCRIPT_PATH="/opt/polar-eyes/storage_pi_four/setup_worker.sh"
        sudo chmod +x $MOUNT_DIR/$SCRIPT_PATH

        echo "Running setup script inside chroot..."
        sudo chroot $MOUNT_DIR /bin/bash -c "$SCRIPT_PATH"
        
        echo "Cleaning up..."
        sudo umount $MOUNT_DIR/sys
        sudo umount $MOUNT_DIR/proc
        sudo umount $MOUNT_DIR/dev/pts
        sudo umount $MOUNT_DIR/dev
        
        sudo umount $MOUNT_DIR/boot/firmware
        sudo umount $MOUNT_DIR
        
        sudo kpartx -dv $LOOP_DEV
        sudo losetup -d $LOOP_DEV
        
        echo "Finalizing artifact..."
        mkdir -p ${{ github.workspace }}/build
        cp $IMAGE_FILE ${{ github.workspace }}/build/polar-eyes-worker-v${{ github.run_number }}.img

    - name: 6. Upload Pi 4 image artifact
      # skip upload if running locally (this token will not be present in the GitHub Local Actions VS Code Extension)
      if: ${{ env.ACT != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: pi4-worker-image
        path: ./build/polar-eyes-worker-v${{ github.run_number }}.img