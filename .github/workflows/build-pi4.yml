name: Build Pi 4 Image

on:
  push:
    paths:
      - 'storage_pi_four/**' # Only run when Pi 4 code/config changes
      - 'storage_pi_four/build-scripts/build-pi4-image.sh'
      - '.github/workflows/build-pi4.yml'
  pull_request:
    paths:
      - 'storage_pi_four/**'
      - 'storage_pi_four/build-scripts/build-pi4-image.sh'
      - '.github/workflows/build-pi4.yml'

jobs:
  build-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    - name: 2. Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static kpartx rsync parted

    - name: 3. Cache Pristine Base Image
      id: cache-raspios
      uses: actions/cache@v4
      with:
        # Cache the .PRISTINE.img, same way as local script does
        path: base-raspios-lite-arm64.PRISTINE.img
        key: ${{ runner.os }}-raspios-trixie-2025-10-01

    - name: 4. Download base Raspberry Pi OS image
      if: steps.cache-raspios.outputs.cache-hit != 'true'
      run: |
        # This whole step will be skipped if the cache was found
        echo "Downloading Base OS..."
        wget -nv https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2025-10-02/2025-10-01-raspios-trixie-arm64-lite.img.xz
        echo "Decompressing..."
        unxz 2025-10-01-raspios-trixie-arm64-lite.img.xz
        # Create the .PRISTINE.img file
        mv 2025-10-01-raspios-trixie-arm64-lite.img base-raspios-lite-arm64.PRISTINE.img
      
    - name: 5. Create Working Copy
      run: |
        echo "Creating fresh working copy for the build..."
        cp base-raspios-lite-arm64.PRISTINE.img base-raspios-lite-arm64.img
        
        echo "Expanding image file by 2GB..."
        # 1. Physically extend file
        truncate -s +2G base-raspios-lite-arm64.img
        
        # 2. Expand partition table
        sudo parted -s base-raspios-lite-arm64.img resizepart 2 100%
        
        # 3. Resize filesystem
        # Attach loop device so we can resize the fs
        LOOP_DEV=$(sudo losetup -P -f --show base-raspios-lite-arm64.img)
        
        # Force check (often required before resize) and then resize
        sudo e2fsck -f -p "${LOOP_DEV}p2" || true
        sudo resize2fs "${LOOP_DEV}p2"
        
        # Cleanup loop device
        sudo losetup -d "$LOOP_DEV"
        echo "Image expansion complete."

    - name: 6. Run Main Build Script
      run: |
        # Make the main build script executable
        chmod +x ./storage_pi_four/build-scripts/build-pi4-image.sh
        
        # Run the script with sudo -E to pass $GITHUB_WORKSPACE
        # GITHUB_RUN_NUMBER is set automatically by the runner
        sudo -E ./storage_pi_four/build-scripts/build-pi4-image.sh

    - name: 7. Upload Pi 4 image artifact
      # skip upload if running locally (with act)
      if: ${{ env.ACT != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: pi4-worker-image
        path: ./build/polar-eyes-worker-v${{ github.run_number }}.img