name: Build Arduino Firmware

on:
  push:
    paths:
      - 'power_controller_nano/**' # Only run when Nano code changes
      - '.github/workflows/build-arduino.yml'
  pull_request:
    paths:
      - 'power_controller_nano/**'
      - '.github/workflows/build-arduino.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    - name: 2. Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh

    - name: 3. Cache Arduino Core & Tools
      id: cache-arduino
      uses: actions/cache@v4
      with:
        path: |
          ~/.arduino15/packages/arduino/hardware/avr
          ~/.arduino15/packages/arduino/tools/avr-gcc
        key: ${{ runner.os }}-arduino-avr-tools

    - name: 4. Install Arduino AVR Core
      # This step will be skipped if the cache was found
      if: steps.cache-arduino.outputs.cache-hit != 'true'
      run: |
        arduino-cli core update-index
        arduino-cli core install arduino:avr

    - name: 5. Compile the sketch
      run: |
        arduino-cli compile \
          --fqbn arduino:avr:nano \
          --build-path ./build \
          ./power_controller_nano/power_controller_nano.ino

    - name: 6. Upload firmware artifact
      # This step will be skipped when running locally with act
      if: ${{ env.ACT != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: nano-firmware
        path: ./build/power_controller_nano.ino.hex